---
title: "Yubikeyã§Kali Linuxã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã‚«ãƒã‚«ãƒã«ã™ã‚‹"
emoji: "ğŸ“"  
type: "tech"
topics: ["security","Yubikey"]
published: true
---

# Yubikeyã§Kali Linuxã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã‚«ãƒã‚«ãƒã«ã™ã‚‹

## ã‚„ã‚‹ã“ã¨
- ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«Yubikeyã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹
- ç”»é¢ãƒ­ãƒƒã‚¯è§£é™¤æ™‚ã«Yubikeyã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹
- sudoæ™‚ã«Yubikeyã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹

## æ³¨æ„ç‚¹
1. ã„ããªã‚Šloginã«è¨­å®šã‚’è¡Œã£ã¦ã€ãƒŸã‚¹ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„ãªã‚“ã¦ã“ã¨ãŒç„¡ã„ã‚ˆã†ã«sudo => login => lightdm(ç”»é¢ãƒ­ãƒƒã‚¯æ™‚) ã®é †ç•ªã§è¨­å®šã—ã¦ã„ã
2. **å¿…ãšãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨Yubikeyã‚’ä½µç”¨ã™ã‚‹ã€‚**  
Yubikeyã¯ã‚ãã¾ã§äºŒè¦ç´ èªè¨¼ã®ãŸã‚ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã‚ã‚‹ãŸã‚ã€Yubikeyã®æ¥ç¶šã®ã¿ã§èªè¨¼ã‚’ã™ã‚‹ã‚ˆã†ãªè¨­å®šã«ã—ãªã„ã“ã¨ã€‚  
YubikeyãŒæ¥ç¶šã•ã‚ŒãŸã¾ã¾ã®PCã‚’ç´›å¤±ã—ãŸå ´åˆã€PCã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ›¸ã‹ã‚ŒãŸä»˜ç®‹ã‚’è²¼ã£ã¦ã„ã‚‹ã‚ˆã†ãªã‚‚ã®ã«ãªã£ã¦ã—ã¾ã†ã€‚

## æ‰‹é †
FIDO U2Fç”¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
```
$ sudo apt install libpam-u2f
```


ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã

è¨­å®šæƒ…å ±æ ¼ç´ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã™ã‚‹
```
$ mkdir -p ~/.config/Yubico
```

Yubikeyã‚’PCã«æ¥ç¶šã™ã‚‹

ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨å…¥åŠ›å¾…æ©ŸçŠ¶æ…‹ã«ãªã‚Šã€
YubikeyãŒç‚¹æ»…ã™ã‚‹ã®ã§ã‚¿ãƒƒãƒã‚»ãƒ³ã‚µéƒ¨åˆ†ã«ã‚¿ãƒƒãƒã™ã‚‹
```
$ pamu2ufg > ~/.config/Yubico/u2f_keys
```

å…¥åŠ›å¾…æ©ŸçŠ¶æ…‹ãŒçµ‚äº†ã—ã€u2f_keysãƒ•ã‚¡ã‚¤ãƒ«ã«æƒ…å ±ãŒå‡ºåŠ›ã•ã‚Œã‚‹

ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒã‚¤ã‚¹ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯ **-n** ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’ **>>** ã«ã™ã‚‹ã“ã¨ã§è¿½åŠ ã§ãã‚‹
```
$ pamu2ufg -n >> ~/.config/Yubico/u2f_keys
```

u2f_keysãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€èª­å–ã«sudoæ¨©é™ãŒå¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã€ã‚ˆã‚Šã‚»ã‚­ãƒ¥ã‚¢ã«ã™ã‚‹
```
$ sudo mkdir /etc/Yubico
$ sudo mv ~/.config/Yubico/u2f_keys /etc/Yubico/u2f_keys
```

**/etc/pam.d/u2f-requisite**ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®å†…å®¹ã‚’æ›¸ãè¾¼ã‚€
```
auth requisite pam_u2f.so debug_file=/var/log/pam_u2f.log

# auth          => ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æœ‰åŠ¹æœŸé™ã‚„èªè¨¼ã®æœ‰åŠ¹æ€§ã«é–¢ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æŒ‡å®š
# requisite     => ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒèªè¨¼ã‚’ç¶™ç¶šã™ã‚‹ã®ã«å¿…é ˆã§ã‚ã‚‹äº‹ã‚’è¡¨ã™ã€‚
# pam_u2f.so    => å®Ÿéš›ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«å
# debug_file=â€¦ => ãƒ‡ãƒãƒƒã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡ºåŠ›å…ˆ
```

## æ³¨æ„ãƒã‚¤ãƒ³ãƒˆ
ä¸Šã®å†…å®¹ã§ã¯äºŒé …ç›®ç›®ã«**requisite**ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ãŒã€ã“ã®è¨­å®šã‚’**required**ã¾ãŸã¯ã€**requisite**ä»¥å¤–ã«è¨­å®šã—ãªã„äº‹ã€‚  
å‰è¿°ã®äºŒã¤ã®ã©ã¡ã‚‰ã‹ã«è¨­å®šã™ã‚‹ã“ã¨ã§Yubikeyã§ã®èªè¨¼ã‚’å¿…é ˆã«ã™ã‚‹ã€‚  
è©³ã—ã„è¨­å®šé …ç›®ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã‚’å‚ç…§  
https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/7/html/system-level_authentication_guide/pam_configuration_files

**/etc/pam.d/sudo**ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹
```diff
#%PAM-1.0

@include common-auth
+ @include u2f-requisite
@include common-account
@include common-session-noninteractive
```

## æ³¨æ„ãƒã‚¤ãƒ³ãƒˆ
å…ˆè¿°ã®**required**ã¾ãŸã¯**requisite**ä»¥å¤–ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒ
**@include common-auth**ã®å‰ã®è¡Œã«è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã¨Yubikeyã®èªè¨¼ãŒé€šã£ãŸæ®µéšã§èªè¨¼OKã«ãªã£ã¦ã—ã¾ã„ã€äºŒè¦ç´ èªè¨¼ã®æ„å‘³ã‚’ãªã•ãªããªã‚‹ã®ã§å¿…ãšä¸Šè¨˜ã®ã‚ˆã†ãªè¨˜è¿°ã«ã™ã‚‹ã“ã¨ã€‚

ä½œæ¥­ä¸­ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã¯é–‰ã˜ãšã«æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ãã€‚  
ã¾ãšã€Yubikeyã‚’æ¥ç¶šã›ãšã«**sudo echo aaaa**ãªã©ã®ã‚³ãƒãƒ³ãƒ‰ã‚’é©å½“ã«æ‰“ã¤ã€‚  
ã“ã“ã¾ã§ã®è¨­å®šãŒæ­£ã—ã‘ã‚Œã°æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ãŸã®ã«ã‚‚é–¢ã‚ã‚‰ãšèªè¨¼ã«å¤±æ•—ã™ã‚‹ã¯ãšã€‚

æ¬¡ã«Yubikeyã‚’æ¥ç¶šã—ãŸçŠ¶æ…‹ã§æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ãã€åŒã˜ã**sudo echo aaaa**ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã€‚  
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¦æ±‚ã•ã‚Œã‚‹ã®ã§æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€YubikeyãŒç‚¹æ»…ã™ã‚‹ã¯ãšã€‚  
ãã®çŠ¶æ…‹ã§Yubikeyã®ã‚¿ãƒƒãƒã‚»ãƒ³ã‚µéƒ¨åˆ†ã«è§¦ã‚Œã‚‹ã¨ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚

ã“ã“ã¾ã§å•é¡Œãªãè¨­å®šå‡ºæ¥ãŸã‚‰æ¬¡ã¯ **/etc/pam.d/login**ã«å¯¾ã—ã¦åŒã˜è¨­å®šã‚’ã—ã¦ã„ãã€‚

viã§é–‹ã„ã¦
```
$ sudo vi /etc/pam.d/login
```
u2f-requisiteã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨˜è¿°
```diff
# Standard Un*x authentication. 
@include common-auth
+ @include u2f-requisite
```

å†èµ·å‹•ã—ã¦ã€Yubikeyã‚’æ¥ç¶šã—ã¦ã„ã‚‹æ™‚ã®ã¿èªè¨¼ã«é€šã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

æœ€å¾Œã¯lightdm(ç”»é¢ãƒ­ãƒƒã‚¯ã‹ã‚‰ã®å¾©å¸°)ã®è¨­å®š

viã§é–‹ã„ã¦
```
$ sudo vi /etc/pam.d/lightdm
```
u2f-requisiteã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨˜è¿°
```diff
# Load environment from /etc/environment and ~/.pam_environment
session   required pam_env.so readenv=1
session   required pam_env.so readenv=1 envfile=/etc/default/locale

@include common-auth
+ @include u2f-requisite
```

è¨­å®šå¾Œã€ä¸€åº¦ç”»é¢ãƒ­ãƒƒã‚¯ã‚’ã—ã¦ã€YubikeyãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã§ã®ã¿ãƒ­ãƒƒã‚¯è§£é™¤ãŒã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

ã“ã‚Œã§ã‚«ãƒã‚«ãƒLinuxã®å®Œæˆã€‚

References:  
https://support.yubico.com/hc/en-us/articles/360016649099-Ubuntu-Linux-Login-Guide-U2F)
https://access.redhat.com/documentation/ja-jp/red_hat_enterprise_linux/7/html/system-level_authentication_guide/pam_configuration_files
