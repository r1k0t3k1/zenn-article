---
title: "Nmapを勉強します"
emoji: "📝"
type: "tech"
topics: ["security"]
published: false
---
# 始めに
個人的に最近Hack The Boxに入門したのですが、Writeupなんかを見てるとほぼ100%使用されるNmap。今回はこれについて、使い方を自分が把握するために記事にしようと思います。

# Nmapの概要
Nmap(Network Mapper)とはネットワークのスキャンに用いられるツールです。単体のホストに対してはもちろんですが、大規模なネットワークも高速でスキャンできるように設計されているようです。</br>
取得可能な情報は

- どのようなホストが利用可能になっているか
- ホストで実行されているOS名とバージョン
- ホストのどのポートがOPEN状態か
- そのポートで動いているサービス名、バージョン

などです。  
  
他にも色々取得できる情報はありそうですが、だいたいの場面で上記の情報で事足りんじゃないかと思っています。

# Nmapがポートを分類するカテゴリ
Nmapはポートスキャンの結果、対象ポートがどのような状態かを表示してくれます。あくまでも『Nmapがそのポートをどのように認識しているか』が表示されるのでNmapを実行するホストのネットワーク上の位置などによって結果が変わってくることに注意が必要です。

| 状態 | 詳細 |
| ---- |  ---- |
| open | アプリケーションがそのポートで接続やパケットを待ち受けていることを示す。</br>攻撃者の好物|
| close | ポート上に待ち受け状態のアプリケーションが存在しない。</br>ただしポートにアクセスする事は可能なので後にこのポートが解放された場合はスキャン対象となる。|
| filtered | FWやフィルタなどによりポートが遮断されている状態でNmapがopenかcloseか判断できない状態。</br>FWやフィルタによってパケットが破棄されるとNmapがネットワーク混雑と判断し、再試行を行うのでスキャンのスピードが落ちる。</br>攻撃者にとって一番嫌な状態 |
| unfiltered | ポートにはアクセス可能だがNmapがopenかcloseか判断できない状態。</br>ポートがこの状態に分類されるのはFWルールを解読するために使用されるACKスキャンのみ。</br>この状態のポートに対してその他のスキャンタイプ(window,SYN,FINなど)を使用するとポートがopenかどうかを判断できる場合がある。 |
|open \| filtered| ポートがopenかfilteredかを判別できない状態。</br>openポートからの応答がないタイプのスキャンにはこのケースが発生する可能性がある。</br>スキャンの応答をFWやフィルタが破棄したことを意味する場合もある。 |
|closed \| unfiltered| ポートが閉じているかフィルタ処理されているかをNmapが判断できない場合に用いられる。</br>IPID Idleスキャンにのみ使用される状態。 |

# ポートスキャンのタイプ
|スキャンタイプ         | オプション | 詳細 |
| ----                  | ----        | ---- |
| TCP SYNスキャン       | -sS         | 一般的に一番良く使用されるスキャンタイプ。</br>root権限がある場合はデフォルトでこのオプションが指定される。</br>完全なTCPコネクションを確立しないため比較的ステルス。
| TCP connectスキャン   | -sT         | 基本的には使わないオプション。</br>SYNスキャンと対照的で完全にTCPコネクションを確立するため接続先のログに残る。</br>root権限が無い場合はデフォルトでこのオプションが指定される。|
| UDPスキャン           | -sU         | UDPプロトコルを使用したスキャン。</br>TCPスキャンと比較して低速。空のUDPヘッダをポートに送ることでスキャンする。</br>このオプションのみ他のTCPスキャンオプションと併用することが可能。 |
| TCP NULLスキャン</br>TCP FINスキャン</br>TCP Xmasスキャン | -sN</br>-sF</br>-sX |RFC 793のSYN、RST、ACKなどのフラグビットを含まないパケットに対する応答パターンによってポートの状態を判断する。|
| TCP ACKスキャン       | -sA         | このオプションはポートをfilteredかunfilteredのみに分類する。ファイアウォールが有効か、どのポートがフィルタされているかを判別するために使用される。|
| TCP Windowスキャン    | -sW         | 特定のシステムの実装に関する情報を用いてopenポートとclosedポートを識別する点を除いて、ACKスキャンと全く同じオプション。 |
| TCP Maimonスキャン    | -sM         | NULL、FIN、Xmasスキャンとほぼ同じ動作で、違いはMaimonスキャンがFIN/ACKフラグを使用すること。|
| カスタムTCPスキャン   | --scanflags | 任意のTCPフラグを指定して独自のスキャンを実行できる。</br>(書式例: --scanflags URGACKPSHRSTSYNFIN)|
| Idleスキャン          | -sI         |このオプションを使用すると、スキャンを実行したPCから対象ホストにパケットが送信されることは無く、対象ホストはゾンビマシンからパケットを受信する。IPIDが増えているかを見る。|
| IP プロトコルスキャン | -sO         | このオプションは対象ホスト上でどのIPプロトコルがサポートされているかを特定する時に利用される。結果として表示されるのはポート番号ではなくIPプロトコル番号になる。|
| FTP バウンススキャン  | -b | FTPサーバーを中継して対象ホストへスキャンを実行する。（プロキシFTP接続の脆弱性を利用する。）たいていのサーバーでは修正されているらしいが、最後の手段として使ってみるのもアリ。</br> IdleスキャンのFTP版？  |

# ポート指定とスキャン順序の指定
|スキャンタイプ|オプション|詳細|
|---|---|---|
|指定ポートのみスキャン| -p <port ranges> | スキャンしたいポートを指定する時に使用する。</br> **-p 8080** のように個別指定もできるし、 **-p 1-1000** のように範囲指定も可能。|
|高速スキャン| -F |Nmap同梱のnmap-servicesファイルに記載のあるポートのみをスキャンする。</br>このファイルに載っているポート数はだいたい1200くらいでデフォルトのTCPスキャンは約1650ポートなのでちょっと早くなるくらい。</br>独自に編集したnmap-serviceファイルを使用することも可能|
|ポート番号順にスキャン| -r |nmapはデフォルトでスキャンするポートの順番はランダムになっているので番号順にスキャンしたい場合はこのオプションを指定する。|

# サービスとバージョンの検出
|スキャンタイプ|オプション|詳細|
|---|---|---|
|バージョン検出|-sV|バージョン検出を実行する。|
|OSとバージョン検出|-A|OS検出とバージョン検出の両方を実行する。|
|バージョン検出の対象から全てのポートを除外しない|--allports|一部のプリンタが9100番ポートに来た通信をなんでも出力するためnmapはこのポートをデフォルトでスキップする。</br>ポートをスキップしたくない場合にこのオプションを指定する。|
|バージョンスキャンの強度を設定|--version-intensity <intensity>||
|ライトモードを有効にする|--version-light|--version-intensity 2 の場合に有用で、サービス特定確率と引き換えにスキャンを通常より高速に実行する。|
|プローブを1つずつ試行する|--version-all|--version-intensity 9 の場合に有用で、各ポートに対してプローブが1つずつ試行されるようになる。|
|バージョンスキャンの動作状況を追跡する|--version-trace|バージョンスキャンがどのように実行されているかに関するデバッグ情報を出力する。|

# OSの検出
|スキャンタイプ|オプション|詳細|
|---|---|---|
|OS検出実行|-o||
|高効率でOS検出を実行|--osscan-limit||
|OS検出結果の推測|--osscan-guess または --fuzzy||

